<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Calculator</title>
    <style>
        /* --- 基础变量 --- */
        :root {
            --bg-color: #000000;
            --btn-gray: #333333;
            --btn-light: #a5a5a5;
            --btn-orange: #ff9f0a;
            --text-white: #ffffff;
            --text-black: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            /* 电脑端背景：浅灰色，用来衬托黑色计算器 */
            background-color: #f2f2f2;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- 核心容器：模拟手机外框 --- */
        .calculator-frame {
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
            overflow: hidden;
            
            /* 电脑端默认样式 (卡片模式) */
            width: 375px;  /* 标准 iPhone 宽度 */
            height: 812px; /* 标准全面屏高度 */
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            padding-bottom: 40px;
        }

        /* --- 提示语 (位置优化：固定在顶部，不挡数字) --- */
        .magic-tip {
            position: absolute;
            top: 60px; /* 固定在顶部，远离显示区 */
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 16px;
            width: 90%;
            text-align: center;
            pointer-events: none;
            transition: opacity 0.3s;
            font-weight: 400;
            letter-spacing: 0.5px;
            z-index: 20;
            line-height: 1.5;
        }

        /* 错误提示抖动动画 */
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
            color: #ff453a !important;
        }

        @keyframes shake {
            10%, 90% { transform: translateX(-50%) translate3d(-1px, 0, 0); }
            20%, 80% { transform: translateX(-50%) translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translateX(-50%) translate3d(-4px, 0, 0); }
            40%, 60% { transform: translateX(-50%) translate3d(4px, 0, 0); }
        }

        /* 显示区域 */
        .display-area {
            width: 100%;
            padding: 0 20px 20px 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            text-align: right;
            margin-bottom: 10px;
        }

        .history-text {
            color: #888;
            font-size: 24px;
            margin-bottom: 5px;
            min-height: 30px;
            font-weight: 300;
            opacity: 0.8;
            white-space: nowrap;
        }

        .current-text {
            color: var(--text-white);
            font-size: 85px;
            font-weight: 300;
            line-height: 1;
            white-space: nowrap;
        }

        /* 键盘区域 */
        .keyboard {
            width: 100%;
            padding: 0 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        /* 按钮通用样式 */
        .btn {
            border: none;
            outline: none;
            border-radius: 50%;
            font-size: 34px;
            font-weight: 400;
            cursor: pointer;
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: filter 0.2s;
            user-select: none;
            touch-action: manipulation; 
        }

        .btn:active {
            filter: brightness(1.3);
        }

        .btn-dark { background-color: var(--btn-gray); color: var(--text-white); }
        .btn-light { background-color: var(--btn-light); color: var(--text-black); font-size: 30px; font-weight: 500; }
        .btn-light:active { background-color: #d9d9d9; filter: none; }
        .btn-orange { background-color: var(--btn-orange); color: var(--text-white); font-size: 42px; padding-bottom: 6px; }
        .btn-orange:active { background-color: #fdbc2c; filter: none; }
        
        .btn-zero {
            grid-column: span 2;
            aspect-ratio: auto;
            border-radius: 45px;
            justify-content: flex-start;
            padding-left: 35px;
        }

        /* --- 手机端适配 (Media Query) --- */
        @media (max-width: 600px) {
            body {
                background-color: #000;
                align-items: flex-end;
            }
            
            .calculator-frame {
                width: 100%;
                height: 100%;
                border-radius: 0;
                box-shadow: none;
            }

            .magic-tip {
                top: 50px;
                font-size: 15px;
            }

            .current-text { font-size: 75px; }
            .btn { font-size: 30px; }
            .keyboard { gap: 12px; }
        }
        
        @media (max-width: 380px) {
            .current-text { font-size: 65px; }
            .btn { font-size: 28px; }
        }
    </style>
</head>
<body>

    <div class="calculator-frame">
        <div class="magic-tip" id="magicTip">第一步：请输入任意 4 位数字</div>

        <div class="display-area">
            <div class="history-text" id="historyDisplay"></div>
            <div class="current-text" id="currentDisplay">0</div>
        </div>

        <div class="keyboard">
            <button class="btn btn-light" id="btnAC">AC</button>
            <button class="btn btn-light invalid-btn">±</button>
            <button class="btn btn-light invalid-btn">%</button>
            <button class="btn btn-orange invalid-btn">÷</button>
            
            <button class="btn btn-dark num-btn" data-num="7">7</button>
            <button class="btn btn-dark num-btn" data-num="8">8</button>
            <button class="btn btn-dark num-btn" data-num="9">9</button>
            <button class="btn btn-orange invalid-btn">×</button>
            
            <button class="btn btn-dark num-btn" data-num="4">4</button>
            <button class="btn btn-dark num-btn" data-num="5">5</button>
            <button class="btn btn-dark num-btn" data-num="6">6</button>
            <button class="btn btn-orange invalid-btn">−</button>
            
            <button class="btn btn-dark num-btn" data-num="1">1</button>
            <button class="btn btn-dark num-btn" data-num="2">2</button>
            <button class="btn btn-dark num-btn" data-num="3">3</button>
            <button class="btn btn-orange" id="btnAdd">+</button>
            
            <button class="btn btn-dark btn-zero num-btn" data-num="0">0</button>
            <button class="btn btn-dark num-btn" data-num=".">.</button>
            <button class="btn btn-orange" id="btnEqual">=</button>
        </div>
    </div>

    <script>
        // --- 核心魔术逻辑 ---
        const state = {
            step: 1, 
            num1: '', 
            num2: '', 
            sum1: 0, 
            targetNum: 0,
            thirdNum: 0,
            currentInput: '0', 
            history: '' 
        };

        const currentDisplay = document.getElementById('currentDisplay');
        const historyDisplay = document.getElementById('historyDisplay');
        const magicTip = document.getElementById('magicTip');
        const btnAC = document.getElementById('btnAC');

        // 数字格式化
        function formatNumber(numStr) {
            if (!numStr) return '';
            if (numStr === '0') return '0';
            return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // 更新 UI
        function updateDisplay() {
            currentDisplay.textContent = formatNumber(state.currentInput);
            
            let formattedHistory = state.history.replace(/\d+/g, (match) => {
                return parseInt(match).toLocaleString();
            });
            historyDisplay.textContent = formattedHistory;

            if (state.currentInput.length > 6) {
                currentDisplay.style.fontSize = '60px';
            } else {
                currentDisplay.style.fontSize = ''; 
            }
            
            if (state.currentInput !== '0' && state.currentInput !== '') {
                btnAC.textContent = 'C';
            } else {
                btnAC.textContent = 'AC';
            }
        }

        // 获取目标时间数字 (核心算法)
        function getTargetTimeNum() {
            const now = new Date();
            let seconds = now.getSeconds();
            let minute = now.getMinutes();
            let hour = now.getHours();
            let month = now.getMonth() + 1;
            let day = now.getDate();
            
            // 进位逻辑：>=40秒算下一分钟
            if (seconds >= 40) {
                minute += 1;
                if (minute >= 60) {
                    minute = 0;
                    hour += 1;
                    if (hour >= 24) {
                        hour = 0;
                        day += 1;
                    }
                }
            }

            const monthStr = month.toString(); 
            const dayStr = day.toString().padStart(2, '0');
            const hourStr = hour.toString().padStart(2, '0');
            const minuteStr = minute.toString().padStart(2, '0');
            
            return parseInt(monthStr + dayStr + hourStr + minuteStr);
        }

        // --- 封装动态计算逻辑 (新增) ---
        // 该函数负责重新获取时间，并计算第三步需要的数字
        function recalculateThirdStep() {
            state.targetNum = getTargetTimeNum();
            state.thirdNum = state.targetNum - state.sum1;
            // 确保第三步的数字不为负数（理论上不会，除非时间穿越了）
            if (state.thirdNum < 0) state.thirdNum = 0;
        }

        // --- 交互事件 ---

        // 1. 数字输入 (包含动态计算)
        document.querySelectorAll('.num-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const num = btn.dataset.num;
                
                if (num === '.') return; 

                // 第三步：障眼法 + 实时计算
                if (state.step === 3) {
                    // 每次按键都重新计算，防止时间跳变导致结果不准
                    recalculateThirdStep();
                    
                    state.currentInput = state.thirdNum.toString();
                    updateDisplay();
                    return;
                }

                // 正常输入逻辑
                const maxLength = state.step === 1 ? 4 : 5;
                if (state.currentInput === '0') {
                    state.currentInput = num;
                } else if (state.currentInput.length < maxLength) {
                    state.currentInput += num;
                }
                updateDisplay();
            });
        });

        // 2. 加号逻辑
        document.getElementById('btnAdd').addEventListener('click', () => {
            if (state.currentInput === '0' && state.step !== 3) return;

            // 位数校验
            const isStep1Valid = state.step === 1 && state.currentInput.length === 4;
            const isStep2Valid = state.step === 2 && state.currentInput.length === 5;

            if ((state.step === 1 && !isStep1Valid) || (state.step === 2 && !isStep2Valid)) {
                const msg = state.step === 1 ? '请输入完整的 4 位数字！' : '请输入完整的 5 位数字！';
                showErrorTip(msg);
                return;
            }

            if (state.step === 1) {
                state.num1 = parseFloat(state.currentInput);
                state.history = state.num1 + '+';
                state.step = 2;
                state.currentInput = '0';
                magicTip.textContent = '第二步：请输入任意 5 位数字';
            } else if (state.step === 2) {
                state.num2 = parseFloat(state.currentInput);
                state.sum1 = state.num1 + state.num2;
                state.history = state.history + state.num2 + '+';
                state.step = 3;
                
                // 首次进入第三步，先计算一次
                recalculateThirdStep();
                
                state.currentInput = '0';
                magicTip.textContent = '第三步：倒扣手机随意点击数字';
            }
            updateDisplay();
        });

        // 3. 等号逻辑 (最终确认)
        document.getElementById('btnEqual').addEventListener('click', () => {
            if (state.step === 3) {
                // 按下等于号的瞬间，再做最后一次时间校验
                recalculateThirdStep();

                const finalResult = state.sum1 + state.thirdNum;
                state.history = ''; 
                state.currentInput = finalResult.toString();
                
                magicTip.textContent = '魔术成功！';
                state.step = 1; 
                updateDisplay();
            }
        });

        // 4. AC 清除
        btnAC.addEventListener('click', () => {
            state.step = 1;
            state.num1 = '';
            state.num2 = '';
            state.sum1 = 0;
            state.targetNum = 0;
            state.thirdNum = 0;
            state.currentInput = '0';
            state.history = '';
            magicTip.textContent = '第一步：请输入任意 4 位数字';
            magicTip.classList.remove('shake');
            magicTip.style.color = 'rgba(255, 255, 255, 0.4)';
            updateDisplay();
        });

        function showErrorTip(text) {
            const originalText = state.step === 1 ? '第一步：请输入任意 4 位数字' : '第二步：请输入任意 5 位数字';
            magicTip.textContent = text;
            magicTip.classList.add('shake');
            magicTip.style.color = '#ff453a';
            if (navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => {
                magicTip.classList.remove('shake');
                magicTip.style.color = 'rgba(255, 255, 255, 0.4)';
                magicTip.textContent = originalText;
            }, 1500);
        }

        document.querySelectorAll('.invalid-btn').forEach(btn => {
            btn.addEventListener('click', () => {});
        });

        updateDisplay();
    </script>
</body>
</html>